<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Elastic Electoral Swing Calculator</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Inter", "Segoe UI", system-ui, sans-serif;
        background: #f5f7fb;
        color: #1f2937;
      }

      body {
        margin: 0;
        padding: 32px;
      }

      .container {
        max-width: 960px;
        margin: 0 auto;
        background: #ffffff;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.08);
        padding: 32px;
      }

      h1 {
        margin-top: 0;
        font-size: 2rem;
      }

      p {
        margin: 0 0 24px;
        color: #4b5563;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 24px;
      }

      th,
      td {
        border-bottom: 1px solid #e5e7eb;
        padding: 12px;
        text-align: left;
      }

      th {
        background: #f8fafc;
        font-weight: 600;
      }

      input[type="text"],
      input[type="number"] {
        width: 100%;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #d1d5db;
        box-sizing: border-box;
        font-size: 0.95rem;
      }

      .actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 24px;
      }

      button {
        border: none;
        background: #2563eb;
        color: #ffffff;
        padding: 10px 18px;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
      }

      button.secondary {
        background: #e5e7eb;
        color: #1f2937;
      }

      .results {
        display: grid;
        gap: 16px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }

      .card {
        padding: 16px;
        border-radius: 12px;
        background: #f8fafc;
        border: 1px solid #e5e7eb;
      }

      .card h3 {
        margin-top: 0;
        font-size: 1rem;
        color: #475569;
      }

      .metric {
        font-size: 1.4rem;
        font-weight: 600;
      }

      .note {
        margin-top: 16px;
        font-size: 0.9rem;
        color: #6b7280;
      }

      .error {
        color: #b91c1c;
        margin-bottom: 16px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Elastic Electoral Swing Calculator</h1>
      <p>
        Model how turnout changes within specific demographics shift the vote share between two
        candidates. All turnout values are whole numbers.
      </p>
      <div id="error" class="error" role="alert"></div>
      <table>
        <thead>
          <tr>
            <th>Demographic</th>
            <th>Baseline voters</th>
            <th>Candidate A support (%)</th>
            <th>Elasticity</th>
            <th>Turnout delta</th>
          </tr>
        </thead>
        <tbody id="demo-rows"></tbody>
      </table>

      <div class="actions">
        <button type="button" id="add-row">Add demographic</button>
        <button type="button" id="calculate">Calculate swing</button>
        <button type="button" class="secondary" id="reset">Reset</button>
      </div>

      <div class="results" id="results" hidden>
        <div class="card">
          <h3>Baseline total voters</h3>
          <div class="metric" id="baseline-total">-</div>
        </div>
        <div class="card">
          <h3>Scenario total voters</h3>
          <div class="metric" id="scenario-total">-</div>
        </div>
        <div class="card">
          <h3>Candidate A swing (votes)</h3>
          <div class="metric" id="swing-votes">-</div>
        </div>
        <div class="card">
          <h3>Candidate A swing (share)</h3>
          <div class="metric" id="swing-share">-</div>
        </div>
        <div class="card">
          <h3>Baseline A share</h3>
          <div class="metric" id="baseline-share">-</div>
        </div>
        <div class="card">
          <h3>Scenario A share</h3>
          <div class="metric" id="scenario-share">-</div>
        </div>
      </div>
      <p class="note">
        Elasticity represents how many percentage points Candidate A gains or loses for each 1%
        turnout change within a demographic.
      </p>
    </div>

    <script>
      const demoRows = document.getElementById("demo-rows");
      const errorEl = document.getElementById("error");
      const resultsEl = document.getElementById("results");

      const initialRows = [
        {
          name: "young_voters",
          baseline_voters: 12000,
          base_support_a: 55,
          elasticity: 0.2,
          turnout_delta: 600,
        },
        {
          name: "suburban_families",
          baseline_voters: 18000,
          base_support_a: 48,
          elasticity: 0.1,
          turnout_delta: 0,
        },
        {
          name: "retirees",
          baseline_voters: 9000,
          base_support_a: 42,
          elasticity: 0.15,
          turnout_delta: -300,
        },
      ];

      const emptyRow = () => ({
        name: "",
        baseline_voters: 0,
        base_support_a: 50,
        elasticity: 0,
        turnout_delta: 0,
      });

      const createCellInput = (value, type = "number") => {
        const input = document.createElement("input");
        input.type = type;
        input.value = value;
        return input;
      };

      const addRow = (row) => {
        const tr = document.createElement("tr");
        const nameCell = document.createElement("td");
        const baseCell = document.createElement("td");
        const supportCell = document.createElement("td");
        const elasticityCell = document.createElement("td");
        const deltaCell = document.createElement("td");

        const nameInput = createCellInput(row.name, "text");
        const baseInput = createCellInput(row.baseline_voters);
        baseInput.min = 0;
        const supportInput = createCellInput(row.base_support_a);
        supportInput.min = 0;
        supportInput.max = 100;
        const elasticityInput = createCellInput(row.elasticity);
        const deltaInput = createCellInput(row.turnout_delta);

        nameCell.appendChild(nameInput);
        baseCell.appendChild(baseInput);
        supportCell.appendChild(supportInput);
        elasticityCell.appendChild(elasticityInput);
        deltaCell.appendChild(deltaInput);

        tr.appendChild(nameCell);
        tr.appendChild(baseCell);
        tr.appendChild(supportCell);
        tr.appendChild(elasticityCell);
        tr.appendChild(deltaCell);
        demoRows.appendChild(tr);
      };

      const renderRows = (rows) => {
        demoRows.innerHTML = "";
        rows.forEach(addRow);
      };

      const gatherPayload = () => {
        const rows = Array.from(demoRows.querySelectorAll("tr"));
        const demographics = [];

        rows.forEach((row) => {
          const inputs = row.querySelectorAll("input");
          const name = inputs[0].value.trim();
          if (!name) {
            return;
          }
          const baseline = Number.parseInt(inputs[1].value, 10) || 0;
          const support = Number.parseFloat(inputs[2].value) || 0;
          const elasticity = Number.parseFloat(inputs[3].value) || 0;
          const delta = Number.parseInt(inputs[4].value, 10) || 0;

          demographics.push({
            name,
            baseline_voters: baseline,
            base_support_a: support,
            elasticity,
            turnout_delta: delta,
          });
        });

        return demographics;
      };

      const clamp = (value, low, high) => Math.max(low, Math.min(value, high));

      const computeOutcome = (demographics, includeDeltas) => {
        let totalVoters = 0;
        let totalVotesA = 0;

        demographics.forEach((demo) => {
          const delta = includeDeltas ? demo.turnout_delta : 0;
          const baselineVoters = demo.baseline_voters;
          const voters = baselineVoters + delta;
          if (voters < 0) {
            throw new Error(`${demo.name}: turnout delta produces negative voters`);
          }
          const turnoutChangePct = baselineVoters ? (delta / baselineVoters) * 100 : 0;
          const adjustedSupport = clamp(
            demo.base_support_a + demo.elasticity * turnoutChangePct,
            0,
            100,
          );
          const votesA = Math.round((voters * adjustedSupport) / 100);

          totalVoters += voters;
          totalVotesA += votesA;
        });

        const votesB = totalVoters - totalVotesA;
        const shareA = totalVoters ? (totalVotesA / totalVoters) * 100 : 0;
        const shareB = totalVoters ? 100 - shareA : 0;

        return {
          total_voters: totalVoters,
          votes_a: totalVotesA,
          votes_b: votesB,
          share_a: shareA,
          share_b: shareB,
        };
      };

      const updateResults = (data) => {
        document.getElementById("baseline-total").textContent = data.baseline.total_voters;
        document.getElementById("scenario-total").textContent = data.scenario.total_voters;
        document.getElementById("swing-votes").textContent = data.vote_swing_a;
        document.getElementById("swing-share").textContent = `${data.share_swing_a.toFixed(2)} pts`;
        document.getElementById("baseline-share").textContent = `${data.baseline.share_a.toFixed(2)}%`;
        document.getElementById("scenario-share").textContent = `${data.scenario.share_a.toFixed(2)}%`;
        resultsEl.hidden = false;
      };

      document.getElementById("add-row").addEventListener("click", () => {
        addRow(emptyRow());
      });

      document.getElementById("reset").addEventListener("click", () => {
        renderRows(initialRows);
        resultsEl.hidden = true;
        errorEl.textContent = "";
      });

      document.getElementById("calculate").addEventListener("click", () => {
        const demographics = gatherPayload();
        if (!demographics.length) {
          errorEl.textContent = "Please add at least one demographic row.";
          resultsEl.hidden = true;
          return;
        }

        try {
          const baseline = computeOutcome(demographics, false);
          const scenario = computeOutcome(demographics, true);
          const voteSwingA = scenario.votes_a - baseline.votes_a;
          const shareSwingA = scenario.share_a - baseline.share_a;

          errorEl.textContent = "";
          updateResults({
            baseline,
            scenario,
            vote_swing_a: voteSwingA,
            share_swing_a: shareSwingA,
          });
        } catch (error) {
          errorEl.textContent = error.message;
          resultsEl.hidden = true;
        }
      });

      renderRows(initialRows);
    </script>
  </body>
</html>
